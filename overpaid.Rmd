---
title: "The Premier League's Most Overpaid Players"
author: "Micah Williams"
date: "2/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(readr)
library(tidyverse)
library(dplyr)
library(gt)
library(tools)
library(fastLink)
library(magrittr)
```

```{r import, message = F, include = F}

# name cleaning process:
  # filter out single-named players (ex. Willian or Rodri)
  # separate first name from last name
  # switch name order ('Firstname' 'Lastname' instead of 'Lastname' 'Firstname')
  # recombine in new column, drop original name columns

# import contract data - 1.29 = current pound-to-dollar exchange rate
pay_2020 <- read_csv('data/contracts.csv', na = c(NA, '', '-')) %>%
  mutate(contract_length = parse_number(contract_length),
         transfer_fee = 1.29*transfer_fee,
         contract_value = 1.29*contract_value,
         team = str_replace(team, ' F.C.',''))

# import player statistics from '18-'19 season
stats_2019 <- read_csv('data/stats_complete_2018.csv') %>% mutate('season' = 2019)

# import player statistics from '19-'20 season
stats_2020 <- read_csv('data/stats_complete.csv') %>% mutate('season' = 2020) 

# combine '19-'20 data with '18-'19 data
combined <- stats_2020 %>% bind_rows(stats_2019)

# save rows with single-name players
single_names <- combined %>% filter(!str_detect(player, ','))

# clean player names
combined <- combined %>%
  filter(str_detect(player, ',')) %>%
  separate(player, c('lastname','firstname'), ', ') %>%
  mutate(player = paste(firstname, lastname, sep = ' '),
         player = str_replace(player, 'Son Heung-min', 'Heung-Min Son')) %>%
  select(player, everything()) %>%
  select(-c(firstname, lastname)) %>%
  bind_rows(single_names)

matches.out <- fastLink(
  dfA = combined, dfB = pay_2020,
  varnames = c('player'),
  stringdist.match = c('player')
)

prem <- getMatches(
  dfA = combined, dfB = pay_2020,
  fl.out = matches.out, threshold.match = 0.65) %>%
  mutate('total_price' = contract_value + transfer_fee)

rm(single_names, stats_2020, stats_2019, matches.out)
```

This table shows the top-paid player (by contract value) for each team in the English Premier League. Some of these players, like Manchester United Goalkeeper David De Gea or Manchester City Midfielder Kevin De Bruyne, are superstars. Others, like Burnley's James Tarkowski or Norwich's Grant Hanley, are less well-known.

At 37 years old, Bournemouth's Jermaine Defoe is among the oldest players in the Premier League, but his hefty contract shows that the club still views him as a valuable asset.

```{r top_paid}
top_paid <- prem %>% 
  filter(!is.na(team)) %>%
  group_by(team) %>% 
  arrange(desc(contract_value)) %>%
  slice(1) %>%
  ungroup()

top_paid$team <- reorder(top_paid$team, top_paid$contract_value)
top_paid$position <- factor(top_paid$position, levels = c('GK', 'D', 'M', 'F'))
 
ggplot(top_paid, aes(x = team, y = contract_value, color = position)) +
  geom_point(size = 2.5) +
  # theme_minimal() +
  scale_color_discrete(name = '') +
  scale_y_log10(
    breaks = c(10*10^6, 20*10^6, 40*10^6, 80*10^6, 160*10^6),
    labels = c('$10M', '$20M', '$40M', '$80M', '$160M')) +
  # annotate('text',
  #          x = top_paid$contract_value, y = 1,
  #          label = top_paid$team,
  #          angle = -90, vjust = 1, hjust = 0,
  #          size = 3.5) +
  # expand_limits(y = 1.5) +
  theme(panel.grid.minor.x = element_blank(),
        legend.direction = 'horizontal',
        legend.position = c(0.75,0.05),
        legend.background = element_blank(),
        legend.key = element_blank()) +
  coord_flip() +
  labs(title = 'Contract Value of Each Team\'s Highest Paid Player',
       x = '', y = 'Contract Value')
```


```{r, include = F}
prem %>% 
  summarize(mean_age = round(mean(age, na.rm = TRUE)),
            avg_games = round(mean(games, na.rm = TRUE)),
            avg_contract = mean(contract_value, na.rm = TRUE)/1000000,
            avg_price = mean(total_price, na.rm = TRUE)/1000000) %>%
  gt() %>%
  cols_align('center') %>%
  tab_header(title = 'Averages') %>%
  fmt_currency(columns = vars(avg_contract, avg_price),
               currency = 'USD') %>%
  cols_label(mean_age = 'Age (years)',
             avg_games = 'Games Played',
             avg_contract = 'Contract (Million $)',
             avg_price = 'Contract + Transfer Fee (Million $)')
```


```{r}
missing_contract <- pay_2020 %>%
  anti_join(prem, by = 'player')

missing_stats <- combined %>%
  anti_join(prem, by = 'player')
```


```{r find_missing}
findmissing <- function(test_string){
  missing_contract %>% filter(str_detect(player, test_string)) %>% pull(player)
  missing_stats %>% filter(str_detect(player, test_string)) %>% pull(player)
  return(list(
    missing_contract,
    missing_stats
  ))
}
```




```{r contract_by_position}
prem$position <- prem$position %>%
  fct_relevel('GK','D','M','F')

par(mfrow = c(1,2))

plot_all <- ggplot(prem %>% filter(contract_value > 0)
                   , aes(position, contract_value/1000000, color = position)) +
  geom_boxplot() +
  geom_jitter(width = 0.25, alpha = 0.2) +
  labs(title = 'Contract Value by Field Position',
       y = 'Contract Value \n (in million $)',
       x = 'Position') +
  theme_minimal() +
  scale_y_log10()

plot_forwards <-
  ggplot(prem %>% filter(position %in% c('M','F'),
                                 !is.na(contract_value),
                                 season == 2019),
    aes(contract_value, goals, color = position)) +
    # facet_wrap(vars(position)) +
    geom_jitter() +
    theme_minimal() + 
    labs(title = 'Contract Value vs. Goals Scored, \'18-\'19 season',
         y = 'Goals Scored',
         x = 'Contract Value') +
    coord_flip() +
    scale_x_log10()

plot_all; plot_forwards
```


```{r, include = F}
prem <- prem %>%
  filter(position %in% c('M','F'),
         goals != 0,
         season == 2020) %>%
  mutate('cost_per_goal' = contract_value/goals)

prem$player <- reorder(prem$player, prem$cost_per_goal)

# prem %>%
#   select(player, cost_per_goal) %>%
#   # head() %>%
#   gt()

ggplot(prem %>% filter(cost_per_goal > 0), aes(player, cost_per_goal, fill = goals)) +
  scale_fill_viridis_c(option = 'A', direction = 1) +
  geom_col() +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank()) +
  labs(title = 'Cost per Goal Scored',
       x = '', y = 'Cost per Goal Scored')


```

```{r}
f_m <- prem %>% filter(position %in% c('M','F'),
                       !is.na(contract_value),
                       contract_value != 0)

get_performance <- function(goals, assists, shots, shots_on_goal, yellow, red, na.rm = TRUE){
    goals * 10 +
    assists * 5 +
    shots_on_goal * 2 +
    shots * 1 +
    yellow * -2 +
    red * -1
}


f_m %<>% mutate('performance' = get_performance(goals, assists, shots, shots_on_goal, yellow, red),
                'performance_cost' = performance / (contract_value / 10000000)) %>%
  arrange(performance_cost) %>%
  slice(1:5, 111:116)

f_m %>% gt()
```


```{r value_plot}
best_value <- f_m %>%
  arrange(desc(performance_cost)) %>%
  group_by(team) %>%
  slice(1)

new_team_order <- reorder(best_value$team, best_value$performance_cost)

f_m$team <- factor(f_m$team, levels(new_team_order))

ggplot(f_m, aes(team, performance_cost, color = log(performance_cost))) +
  geom_point() +
  scale_color_continuous(low = '#990055', high = '#4477ff') +
  scale_y_log10() +
  theme_minimal() +
  theme(legend.position = 'none') +
  labs(title = 'Player Performance Scores by Team',
       subtitle = 'Ordered by each team\'s highest performance score player',
       y = 'Performance Score',
       x = 'Team')+
  coord_flip()
```

